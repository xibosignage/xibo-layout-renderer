{"version":3,"file":"xibo-layout-renderer.min.js","sources":["../node_modules/nanoevents/index.js","../../src/Modules/Platform/Platform.ts","../../src/Types/Layout/Layout.types.ts","../../src/Modules/Generators/Generators.ts","../../src/Types/Region/Region.types.ts","../../src/Types/Media/Media.types.ts","../../src/Modules/Transitions/Transitions.ts","../../src/Modules/Media/VideoMedia.ts","../../src/Modules/Media/ObjectMedia.ts","../../src/Modules/Media/Media.ts","../../src/Modules/Media/AudioMedia.ts","../../src/Modules/Layout/Layout.ts","../../src/Modules/Region/Region.ts","../../src/Types/XLR/XLR.types.ts","../../src/xibo-layout-renderer.ts"],"sourcesContent":["export let createNanoEvents = () => ({\n  emit(event, ...args) {\n    for (\n      let i = 0,\n        callbacks = this.events[event] || [],\n        length = callbacks.length;\n      i < length;\n      i++\n    ) {\n      callbacks[i](...args)\n    }\n  },\n  events: {},\n  on(event, cb) {\n    ;(this.events[event] ||= []).push(cb)\n    return () => {\n      this.events[event] = this.events[event]?.filter(i => cb !== i)\n    }\n  }\n})\n","/*\r\n * Copyright (C) 2024 Xibo Signage Ltd\r\n *\r\n * Xibo - Digital Signage - https://www.xibosignage.com\r\n *\r\n * This file is part of Xibo.\r\n *\r\n * Xibo is free software: you can redistribute it and/or modify\r\n * it under the terms of the GNU Lesser General Public License as published by\r\n * the Free Software Foundation, either version 3 of the License, or\r\n * any later version.\r\n *\r\n * Xibo is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n * GNU Lesser General Public License for more details.\r\n *\r\n * You should have received a copy of the GNU Lesser General Public License\r\n * along with Xibo.  If not, see <http://www.gnu.org/licenses/>.\r\n */\r\nimport {OptionsType} from \"../../Types/Layout\";\r\n\r\nconst RESOURCE_URL = '/playlist/widget/resource/:regionId/:id';\r\nconst XLF_URL = '/layout/xlf/:layoutId';\r\nconst LAYOUT_BACKGROUND_DOWNLOAD_URL = '/layout/background/:id';\r\nconst LAYOUT_PREVIEW_URL = '/layout/preview/[layoutCode]';\r\nconst LIBRARY_DOWNLOAD_URL = '/library/download/:id';\r\nconst LOADER_URL = '/theme/default/img/loader.gif';\r\n\r\nexport const platform: OptionsType = {\r\n    getResourceUrl: RESOURCE_URL,\r\n    xlfUrl: XLF_URL,\r\n    layoutBackgroundDownloadUrl: LAYOUT_BACKGROUND_DOWNLOAD_URL,\r\n    layoutPreviewUrl: LAYOUT_PREVIEW_URL,\r\n    libraryDownloadUrl: LIBRARY_DOWNLOAD_URL,\r\n    loaderUrl: LOADER_URL,\r\n    idCounter: 0,\r\n    inPreview: true,\r\n    appHost: null,\r\n    platform: 'CMS',\r\n};\r\n","/*\r\n * Copyright (C) 2024 Xibo Signage Ltd\r\n *\r\n * Xibo - Digital Signage - https://www.xibosignage.com\r\n *\r\n * This file is part of Xibo.\r\n *\r\n * Xibo is free software: you can redistribute it and/or modify\r\n * it under the terms of the GNU Lesser General Public License as published by\r\n * the Free Software Foundation, either version 3 of the License, or\r\n * any later version.\r\n *\r\n * Xibo is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n * GNU Lesser General Public License for more details.\r\n *\r\n * You should have received a copy of the GNU Lesser General Public License\r\n * along with Xibo.  If not, see <http://www.gnu.org/licenses/>.\r\n */\r\nimport {DefaultEvents, Emitter, Unsubscribe} from \"nanoevents\";\r\nimport {IRegion} from \"../Region\";\r\nimport {platform} from \"../../Modules/Platform\";\r\nimport {ILayoutEvents} from \"../../Modules/Layout\";\r\nimport {IXlr} from \"../XLR\";\r\n\r\nexport type InputLayoutType = {\r\n    layoutId: number | null;\r\n    path?: string;\r\n};\r\n\r\nexport type OptionsType = {\r\n    xlfUrl: string;\r\n    getResourceUrl: string;\r\n    layoutBackgroundDownloadUrl: string;\r\n    layoutPreviewUrl: string;\r\n    libraryDownloadUrl: string;\r\n    loaderUrl: string;\r\n    idCounter: number;\r\n    inPreview: boolean;\r\n    appHost?: string | null;\r\n    platform: 'CMS' | 'chromeOS';\r\n    config?: {\r\n        cmsUrl: string | null;\r\n        schemaVersion: number;\r\n        cmsKey: string | null;\r\n        hardwareKey: string | null;\r\n    };\r\n};\r\n\r\nexport interface ILayout {\r\n    id: number | null;\r\n    layoutId: number | null;\r\n    sw: number | null;\r\n    sh: number | null;\r\n    xw: number | null;\r\n    xh: number | null;\r\n    zIndex: number | null;\r\n    scaleFactor: number;\r\n    sWidth: number;\r\n    sHeight: number;\r\n    offsetX: number;\r\n    offsetY: number;\r\n    bgColor: string;\r\n    bgImage: string;\r\n    bgId: string;\r\n    containerName: string;\r\n    layoutNode: Document | null;\r\n    regionMaxZIndex: number;\r\n    ready: boolean;\r\n    regionObjects: IRegion[];\r\n    drawer: String[];\r\n    allExpired: boolean;\r\n    regions: IRegion[];\r\n    actions: String[];\r\n    options: OptionsType;\r\n    done: boolean;\r\n    allEnded: boolean;\r\n    path?: string;\r\n    prepareLayout(): void;\r\n    parseXlf(): void;\r\n    run(): void;\r\n    emitter?: Emitter<DefaultEvents>;\r\n    on<E extends keyof ILayoutEvents>(event: E, callback: ILayoutEvents[E]): Unsubscribe;\r\n    regionExpired(): void;\r\n    end(): void;\r\n    regionEnded(): void;\r\n    stopAllMedia(): Promise<void>;\r\n}\r\n\r\nexport const initialLayout: ILayout = {\r\n    id: null,\r\n    layoutId: null,\r\n    sw: 0,\r\n    sh: 0,\r\n    xw: 0,\r\n    xh: 0,\r\n    zIndex: 0,\r\n    scaleFactor: 1,\r\n    sWidth: 0,\r\n    sHeight: 0,\r\n    offsetX: 0,\r\n    offsetY: 0,\r\n    bgColor: '',\r\n    bgImage: '',\r\n    bgId: '',\r\n    containerName: '',\r\n    layoutNode: null,\r\n    regionMaxZIndex: 0,\r\n    ready: false,\r\n    regionObjects: [],\r\n    drawer: [],\r\n    allExpired: false,\r\n    regions: [],\r\n    actions: [],\r\n    options: platform,\r\n    done: false,\r\n    allEnded: false,\r\n    path: '',\r\n    prepareLayout() {\r\n    },\r\n    parseXlf() {\r\n    },\r\n    run() {\r\n    },\r\n    on<E extends keyof ILayoutEvents>(event: E, callback: ILayoutEvents[E]): Unsubscribe {\r\n        return <Unsubscribe>{};\r\n    },\r\n    regionExpired() {\r\n    },\r\n    end() {\r\n    },\r\n    regionEnded() {\r\n    },\r\n    stopAllMedia() {\r\n        return Promise.resolve();\r\n    },\r\n};\r\n\r\nexport type GetLayoutParamType = {\r\n    xlr: IXlr;\r\n    moveNext?: boolean;\r\n}\r\n\r\nexport type GetLayoutType = {\r\n    currentLayoutIndex: number;\r\n    inputLayouts: InputLayoutType[];\r\n    current: ILayout | undefined;\r\n    next: ILayout | undefined;\r\n}\r\n","/*\r\n * Copyright (C) 2024 Xibo Signage Ltd\r\n *\r\n * Xibo - Digital Signage - https://www.xibosignage.com\r\n *\r\n * This file is part of Xibo.\r\n *\r\n * Xibo is free software: you can redistribute it and/or modify\r\n * it under the terms of the GNU Lesser General Public License as published by\r\n * the Free Software Foundation, either version 3 of the License, or\r\n * any later version.\r\n *\r\n * Xibo is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n * GNU Lesser General Public License for more details.\r\n *\r\n * You should have received a copy of the GNU Lesser General Public License\r\n * along with Xibo.  If not, see <http://www.gnu.org/licenses/>.\r\n */\r\nimport { IMedia } from '../../Types/Media';\r\nimport {InputLayoutType, OptionsType} from \"../../Types/Layout\";\r\n\r\nexport function nextId(options: { idCounter: number; }) {\r\n    if (options.idCounter > 500) {\r\n        options.idCounter = 0;\r\n    }\r\n\r\n    options.idCounter = options.idCounter + 1;\r\n    return options.idCounter;\r\n}\r\n\r\nexport const getMediaId = ({mediaType, containerName}: IMedia) => {\r\n    let mediaId = containerName;\r\n\r\n    if (mediaType === 'video') {\r\n        mediaId = mediaId + '-vid';\r\n    } else if (mediaType === 'audio') {\r\n        mediaId = mediaId + '-aud';\r\n    }\r\n\r\n    return mediaId;\r\n};\r\n\r\nexport const capitalizeStr = (inputStr: string) => {\r\n    if (inputStr === null) {\r\n        return '';\r\n    }\r\n\r\n    return String(inputStr).charAt(0).toUpperCase() + String(inputStr).substring(1);\r\n};\r\n\r\nexport async function getDataBlob(src: string) {\r\n    return fetch(src, {mode: 'no-cors'})\r\n        .then((res) => res.blob())\r\n        .then((blob) => new Promise((res, rej) => {\r\n            const reader = new FileReader();\r\n\r\n            reader.onloadend = () => res(reader.result);\r\n            reader.onerror = rej;\r\n            reader.readAsDataURL(blob);\r\n        }));\r\n}\r\n\r\nexport async function preloadMediaBlob(src: string, type: 'video' | 'audio' | 'image') {\r\n    const res = await fetch(src, {mode: 'no-cors'});\r\n    let blob: Blob | MediaSource = new Blob();\r\n\r\n    if (type === 'image') {\r\n        blob = new Blob()\r\n    } else if (type === 'video') {\r\n        blob = await res.blob();\r\n    } else if (type === 'audio') {\r\n        const data = await res.arrayBuffer();\r\n        blob = new Blob([data], { type: audioFileType(getFileExt(src)) })\r\n    }\r\n\r\n    return URL.createObjectURL(blob);\r\n}\r\n\r\nexport async function fetchJSON(url: string) {\r\n    return fetch(url)\r\n        .then(res => res.json())\r\n        .catch(err => {\r\n            console.log(err);\r\n        });\r\n}\r\n\r\nexport function getFileExt(filename: string) {\r\n    const filenameArr = String(filename).split('.');\r\n\r\n    return filenameArr[filenameArr.length - 1];\r\n}\r\n\r\nexport function audioFileType(str: string) {\r\n    const validAudioTypes = {\r\n        'mp3': 'audio/mp3',\r\n        'wav': 'audio/wav',\r\n        'ogg': 'audio/ogg',\r\n    };\r\n\r\n    if (Boolean(validAudioTypes[str as 'mp3' | 'wav' | 'ogg'])) {\r\n        return validAudioTypes[str as 'mp3' | 'wav' | 'ogg'];\r\n    }\r\n\r\n    return undefined;\r\n}\r\n\r\nexport function composeResourceUrlByPlatform(platform: OptionsType['platform'], params: any) {\r\n    let resourceUrl = params.regionOptions.getResourceUrl\r\n        .replace(\":regionId\", params.regionId)\r\n        .replace(\":id\", params.mediaId) +\r\n        '?preview=1&layoutPreview=1';\r\n\r\n    if (platform === 'chromeOS') {\r\n        resourceUrl = params.cmsUrl +\r\n            '/chromeOS/resource/' +\r\n            params.fileId +\r\n            '?saveAs=' + params.uri;\r\n    } else if (!Boolean(params['mediaType'])) {\r\n        resourceUrl += '&scale_override=' + params.scaleFactor;\r\n    }\r\n\r\n    return resourceUrl;\r\n}\r\n\r\nexport function composeBgUrlByPlatform(\r\n    platform: OptionsType['platform'],\r\n    params: any\r\n) {\r\n    let bgImageUrl = params.layoutBackgroundDownloadUrl.replace(\":id\", (params.layout.id as unknown) as string) +\r\n        '?preview=1&width=' + params.layout.sWidth +\r\n        '&height=' + params.layout.sHeight +\r\n        '&dynamic&proportional=0';\r\n\r\n    if (platform === 'chromeOS') {\r\n        bgImageUrl = params.cmsUrl +\r\n            '/chromeOS/resource/' + params.layout.id +\r\n            '?saveAs=' + params.layout.bgImage;\r\n    }\r\n\r\n    return bgImageUrl;\r\n}\r\n\r\ntype LayoutIndexType = {\r\n    [k: string]: InputLayoutType & {\r\n        index: number;\r\n    }\r\n}\r\n\r\nexport function getIndexByLayoutId(layoutsInput: InputLayoutType[], layoutId?: number | null) {\r\n    let layoutIndexes = layoutsInput.reduce((a: LayoutIndexType, b, indx) => {\r\n        a[Number(b.layoutId)] = {\r\n            ...b,\r\n            index: indx\r\n        };\r\n\r\n        return a;\r\n    }, {});\r\n\r\n    if (layoutId === null || !layoutId) {\r\n        return layoutIndexes;\r\n    }\r\n\r\n    return layoutIndexes[layoutId];\r\n}\r\n\r\nexport function isEmpty(input: any) {\r\n    return !Boolean(input) || String(input).length === 0;\r\n}\r\n","/*\r\n * Copyright (C) 2024 Xibo Signage Ltd\r\n *\r\n * Xibo - Digital Signage - https://www.xibosignage.com\r\n *\r\n * This file is part of Xibo.\r\n *\r\n * Xibo is free software: you can redistribute it and/or modify\r\n * it under the terms of the GNU Lesser General Public License as published by\r\n * the Free Software Foundation, either version 3 of the License, or\r\n * any later version.\r\n *\r\n * Xibo is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n * GNU Lesser General Public License for more details.\r\n *\r\n * You should have received a copy of the GNU Lesser General Public License\r\n * along with Xibo.  If not, see <http://www.gnu.org/licenses/>.\r\n */\r\nimport { DefaultEvents, Emitter, Unsubscribe } from \"nanoevents\";\r\nimport {ILayout, initialLayout, OptionsType} from \"../Layout/Layout.types\";\r\nimport {platform} from \"../../Modules/Platform/Platform\";\r\nimport {IMedia} from \"../Media/Media.types\";\r\n\r\nexport interface IRegionEvents {\r\n    start: (layout: IRegion) => void;\r\n    end: (layout: IRegion) => void;\r\n}\r\n\r\nexport interface IRegion {\r\n    layout: ILayout;\r\n    id: string;\r\n    regionId: string;\r\n    xml: null | Element;\r\n    mediaObjects: IMedia[];\r\n    mediaObjectsActions: String[];\r\n    currentMedia: number;\r\n    complete: boolean;\r\n    containerName: string;\r\n    ending: boolean;\r\n    ended: boolean;\r\n    oneMedia: boolean;\r\n    oldMedia: IMedia | undefined;\r\n    curMedia: IMedia | undefined;\r\n    nxtMedia: IMedia | undefined;\r\n    currentMediaIndex: number;\r\n    totalMediaObjects: number;\r\n    ready: boolean;\r\n    options: {\r\n        [k: string]: any;\r\n    };\r\n    sWidth: number;\r\n    sHeight: number;\r\n    offsetX: number;\r\n    offsetY: number;\r\n    zIndex: number;\r\n    index: number;\r\n    emitter?: Emitter<DefaultEvents>;\r\n    prepareRegion(): void;\r\n    playNextMedia(): void;\r\n    transitionNodes(oldMedia: IMedia | undefined, newMedia: IMedia | undefined): void;\r\n    finished(): void;\r\n    run(): void;\r\n    end(): void;\r\n    exitTransition(): void;\r\n    exitTransitionComplete(): void;\r\n    on<E extends keyof IRegionEvents>(event: E, callback: IRegionEvents[E]): Unsubscribe;\r\n    prepareMediaObjects(): void;\r\n}\r\n\r\nexport const initialRegion: IRegion = {\r\n    layout: initialLayout,\r\n    id: '',\r\n    regionId: '',\r\n    xml: null,\r\n    mediaObjects: [],\r\n    mediaObjectsActions: [],\r\n    currentMedia: -1,\r\n    complete: false,\r\n    containerName: '',\r\n    ending: false,\r\n    ended: false,\r\n    oneMedia: false,\r\n    oldMedia: undefined,\r\n    curMedia: undefined,\r\n    nxtMedia: undefined,\r\n    currentMediaIndex: 0,\r\n    totalMediaObjects: 0,\r\n    ready: false,\r\n    options: {},\r\n    sWidth: 0,\r\n    sHeight: 0,\r\n    offsetX: 0,\r\n    offsetY: 0,\r\n    zIndex: 0,\r\n    index: -1,\r\n    prepareRegion() {\r\n    },\r\n    playNextMedia() {\r\n    },\r\n    transitionNodes() {\r\n    },\r\n    finished() {\r\n    },\r\n    run() {\r\n    },\r\n    end() {\r\n    },\r\n    exitTransition() {},\r\n    exitTransitionComplete() {},\r\n    on<E extends keyof IRegionEvents>(event: E, callback: IRegionEvents[E]): Unsubscribe {\r\n        return <Unsubscribe>{};\r\n    },\r\n    prepareMediaObjects() {\r\n    },\r\n};\r\n","/*\r\n * Copyright (C) 2024 Xibo Signage Ltd\r\n *\r\n * Xibo - Digital Signage - https://www.xibosignage.com\r\n *\r\n * This file is part of Xibo.\r\n *\r\n * Xibo is free software: you can redistribute it and/or modify\r\n * it under the terms of the GNU Lesser General Public License as published by\r\n * the Free Software Foundation, either version 3 of the License, or\r\n * any later version.\r\n *\r\n * Xibo is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n * GNU Lesser General Public License for more details.\r\n *\r\n * You should have received a copy of the GNU Lesser General Public License\r\n * along with Xibo.  If not, see <http://www.gnu.org/licenses/>.\r\n */\r\nimport { DefaultEvents, Emitter, Unsubscribe } from \"nanoevents\";\r\nimport { IMediaEvents } from \"../../Modules/Media/Media\";\r\nimport {initialRegion, IRegion} from \"../Region/Region.types\";\r\n\r\nexport interface IMedia {\r\n    region: IRegion;\r\n    xml: null | Element;\r\n    id: string;\r\n    idCounter: number;\r\n    index: number;\r\n    containerName: string;\r\n    html: null | HTMLElement;\r\n    iframe: null | HTMLIFrameElement;\r\n    iframeName: string;\r\n    mediaType: string;\r\n    render: string;\r\n    attachedAudio: boolean;\r\n    singlePlay: boolean;\r\n    timeoutId: ReturnType<typeof setTimeout>;\r\n    ready: boolean;\r\n    checkIframeStatus: boolean;\r\n    loadIframeOnRun: boolean;\r\n    tempSrc: string;\r\n    finished: boolean;\r\n    schemaVersion: string;\r\n    type: string;\r\n    duration: number;\r\n    useDuration: boolean;\r\n    fileId: string;\r\n    uri: string;\r\n    options: {\r\n        [k: string]: any;\r\n    };\r\n    divWidth: number;\r\n    divHeight: number;\r\n    url: string | null;\r\n    loop: boolean;\r\n    emitter?: Emitter<DefaultEvents>;\r\n    run(): void;\r\n    init(): void;\r\n    stop(): Promise<void>;\r\n    on<E extends keyof IMediaEvents>(event: E, callback: IMediaEvents[E]): Unsubscribe;\r\n}\r\n\r\nexport const initialMedia: IMedia = {\r\n    region: initialRegion,\r\n    xml: null,\r\n    id: '',\r\n    index: 0,\r\n    idCounter: 0,\r\n    containerName: '',\r\n    html: null,\r\n    iframe: null,\r\n    iframeName: '',\r\n    mediaType: '',\r\n    render: 'html',\r\n    attachedAudio: false,\r\n    singlePlay: false,\r\n    timeoutId: setTimeout(() => {}, 100),\r\n    ready: true,\r\n    checkIframeStatus: false,\r\n    loadIframeOnRun: false,\r\n    tempSrc: '',\r\n    finished: false,\r\n    schemaVersion: '1',\r\n    type: '',\r\n    duration: 0,\r\n    useDuration: Boolean(0),\r\n    fileId: '',\r\n    uri: '',\r\n    options: {},\r\n    divWidth: 0,\r\n    divHeight: 0,\r\n    url: null,\r\n    loop: false,\r\n    run() {},\r\n    init() {},\r\n    stop() {\r\n        return Promise.resolve();\r\n    },\r\n    on<E extends keyof IMediaEvents>(event: E, callback: IMediaEvents[E]): Unsubscribe {\r\n        return <Unsubscribe>{};\r\n    },\r\n}\r\n","/*\n * Copyright (C) 2024 Xibo Signage Ltd\n *\n * Xibo - Digital Signage - https://www.xibosignage.com\n *\n * This file is part of Xibo.\n *\n * Xibo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Lesser General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * any later version.\n *\n * Xibo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Lesser General Public License for more details.\n *\n * You should have received a copy of the GNU Lesser General Public License\n * along with Xibo.  If not, see <http://www.gnu.org/licenses/>.\n */\nexport const defaultTrans = (duration: number, trans: 'in' | 'out') => {\n    const defaultKeyframes = [\n        { display: trans === 'in' ? 'none' : 'block' },\n        { display: trans === 'out' ? 'none' : 'block' },\n    ];\n    const defaultTiming: number | KeyframeAnimationOptions | undefined = {\n        duration,\n    };\n\n    return {\n        keyframes: defaultKeyframes,\n        timing: defaultTiming,\n    };\n};\n\nexport const fadeInElem = (duration: number) => {\n    const fadeInKeyframes = [\n        { opacity: 0 },\n        { opacity: 1 },\n    ];\n    const fadeInTiming: number | KeyframeAnimationOptions | undefined = {\n        duration,\n        fill: 'forwards',\n    };\n\n    return {\n        keyframes: fadeInKeyframes,\n        timing: fadeInTiming,\n    }\n};\n\nexport const fadeOutElem = (duration: number) => {\n    const fadeOutKeyframes = [\n        { opacity: 1 },\n        { opacity: 0, zIndex: -1 },\n    ];\n    const fadeOutTiming: number | KeyframeAnimationOptions | undefined = {\n        duration,\n        fill: 'forwards',\n    };\n\n    return {\n        keyframes: fadeOutKeyframes,\n        timing: fadeOutTiming,\n    }\n};\n\nexport type KeyframeOptionsType = {\n    from: {\n        [k: string]: any,\n    },\n    to: {\n        [k: string]: any,\n    },\n}\n\nexport const flyInElem = (duration: number, keyframeOptions: KeyframeOptionsType | undefined, direction?: string) => {\n    const flyInKeyframes = [\n        {opacity: 0},\n        {opacity: 1, zIndex: 1},\n    ];\n    const flyInTiming: number | KeyframeAnimationOptions | undefined = {\n        duration,\n        fill: 'forwards',\n    };\n\n    if (keyframeOptions && Boolean(keyframeOptions.from)) {\n        flyInKeyframes[0] = {...keyframeOptions.from, ...flyInKeyframes[0]};\n    }\n\n    if (keyframeOptions && Boolean(keyframeOptions.to)) {\n        flyInKeyframes[1] = {...keyframeOptions.to, ...flyInKeyframes[1]};\n    }\n\n    return {\n        keyframes: flyInKeyframes,\n        timing: flyInTiming,\n    };\n};\n\nexport const flyOutElem = (duration: number, keyframeOptions: KeyframeOptionsType | undefined, direction?: string) => {\n    const flyOutKeyframes: Keyframe[] = [\n        {opacity: 1},\n        {opacity: 0, zIndex: -1},\n    ];\n    const flyOutTiming: number | KeyframeAnimationOptions | undefined = {\n        duration,\n        fill: 'forwards',\n    };\n\n    if (keyframeOptions && Boolean(keyframeOptions.from)) {\n        flyOutKeyframes[0] = {...keyframeOptions.from, ...flyOutKeyframes[0]};\n    }\n\n    if (keyframeOptions && Boolean(keyframeOptions.to)) {\n        flyOutKeyframes[1] = {...keyframeOptions.to, ...flyOutKeyframes[1]};\n    }\n\n    return {\n        keyframes: flyOutKeyframes,\n        timing: flyOutTiming,\n    };\n};\n\nexport type TransitionNameType = 'fadeIn' | 'fadeOut' | 'flyIn' | 'flyOut' | 'defaultIn' | 'defaultOut';\n\nexport type TransitionElementOptions = {\n    duration: number;\n    keyframes?: KeyframeOptionsType;\n    direction?: string;\n};\n\nexport const transitionElement = (transition: TransitionNameType, options: TransitionElementOptions) => {\n    const transitions = {\n        fadeIn: fadeInElem(options.duration),\n        fadeOut: fadeOutElem(options.duration),\n        flyIn: flyInElem(options.duration, options.keyframes, options.direction),\n        flyOut: flyOutElem(options.duration, options.keyframes, options.direction),\n        defaultIn: defaultTrans(options.duration, 'in'),\n        defaultOut: defaultTrans(options.duration, 'out'),\n    };\n\n    return transitions[transition];\n};\n\nexport type compassPoints = 'N' | 'NE' | 'E' | 'SE' | 'S' | 'SW' | 'W' | 'NW';\n\nexport type flyTransitionParams = {\n    trans: 'in' | 'out';\n    direction: compassPoints;\n    height: string | number;\n    width: string | number;\n};\n\nexport const flyTransitionKeyframes = (params: flyTransitionParams): KeyframeOptionsType => {\n    const keyframes = {\n        from: {},\n        to: {},\n    };\n    const opacityAttr = (source: 'from' | 'to') => {\n        if (source === 'from') {\n            return params.trans === 'in' ? 0 : 1;\n        }\n        \n        return params.trans === 'out' ? 1 : 0;\n    };\n\n    switch (params.direction) {\n        case 'N':\n            keyframes.from = {\n                opacity: opacityAttr('from'),\n                top: params.trans === 'in' ? `${params.height}px` : 0,\n            };\n            keyframes.to = {\n                opacity: opacityAttr('to'),\n                top: params.trans === 'in' ? 0 : `-${params.height}px`,\n            };\n            break;\n        case 'NE':\n            keyframes.from = {\n                opacity: opacityAttr('from'),\n                top: params.trans === 'in' ? `${params.height}px` : 0,\n                left: params.trans === 'in' ? `-${params.width}px` : 0,\n            };\n            keyframes.to = {\n                opacity: opacityAttr('to'),\n                top: params.trans === 'in' ? 0 : `-${params.height}px`,\n                left: params.trans === 'in' ? 0 : `${params.width}px`,\n            };\n            break;\n        case 'E':\n            keyframes.from = {\n                opacity: opacityAttr('from'),\n                left: params.trans === 'in' ? `-${params.width}px` : 0,\n            };\n            keyframes.to = {\n                opacity: opacityAttr('to'),\n                left: params.trans === 'in' ? 0 : `${params.width}px`,\n            };\n            break;\n        case 'SE':\n            keyframes.from = {\n                opacity: opacityAttr('from'),\n                top: params.trans === 'in' ? `-${params.height}px` : 0,\n                left: params.trans === 'in' ? `-${params.width}px` : 0,\n            };\n            keyframes.to = {\n                opacity: opacityAttr('to'),\n                top: params.trans === 'in' ? 0 : `${params.height}px`,\n                left: params.trans === 'in' ? 0 : `${params.width}px`,\n            };\n            break;\n        case 'S':\n            keyframes.from = {\n                opacity: opacityAttr('from'),\n                top: params.trans === 'in' ? `-${params.height}px` : 0,\n            };\n            keyframes.to = {\n                opacity: opacityAttr('to'),\n                top: params.trans === 'in' ? 0 : `${params.height}px`,\n            };\n            break;\n        case 'SW':\n            keyframes.from = {\n                opacity: opacityAttr('from'),\n                top: params.trans === 'in' ? `-${params.height}px` : 0,\n                left: params.trans === 'in' ? `${params.width}px` : 0,\n            };\n            keyframes.to = {\n                opacity: opacityAttr('to'),\n                top: params.trans === 'in' ? 0 : `${params.height}px`,\n                left: params.trans === 'in' ? 0 : `-${params.width}px`,\n            };\n            break;\n        case 'W':\n            keyframes.from = {\n                opacity: opacityAttr('from'),\n                left: params.trans === 'in' ? `${params.width}px` : 0,\n            };\n            keyframes.to = {\n                opacity: opacityAttr('to'),\n                left: params.trans === 'in' ? 0 : `-${params.width}px`,\n            };\n            break;\n        case 'NW':\n            keyframes.from = {\n                opacity: opacityAttr('from'),\n                top: params.trans === 'in' ? `${params.height}px` : 0,\n                left: params.trans === 'in' ? `${params.width}px` : 0,\n            };\n            keyframes.to = {\n                opacity: opacityAttr('to'),\n                top: params.trans === 'in' ? 0 : `-${params.height}px`,\n                left: params.trans === 'in' ? 0 : `-${params.width}px`,\n            };\n            break;\n        default:\n            keyframes.from = {\n                opacity: opacityAttr('from'),\n                top: params.trans === 'in' ? `${params.height}px` : 0,\n            };\n            keyframes.to = {\n                opacity: opacityAttr('to'),\n                top: params.trans === 'in' ? 0 : `-${params.height}px`,\n            };\n            break;\n    }\n\n    return keyframes;\n};\n","/*\n * Copyright (C) 2024 Xibo Signage Ltd\n *\n * Xibo - Digital Signage - https://www.xibosignage.com\n *\n * This file is part of Xibo.\n *\n * Xibo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Lesser General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * any later version.\n *\n * Xibo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Lesser General Public License for more details.\n *\n * You should have received a copy of the GNU Lesser General Public License\n * along with Xibo.  If not, see <http://www.gnu.org/licenses/>.\n */\nimport { IMedia } from '../../Types/Media';\nimport { capitalizeStr, getMediaId } from '../Generators';\n\nexport default function VideoMedia(media: IMedia) {\n    const videoMediaObject = {\n        prepare($videoMedia: HTMLVideoElement) {\n            $videoMedia.preload = 'auto';\n            $videoMedia.textContent = 'Unsupported Video';\n\n            if (Boolean(media.options['mute'])) {\n                $videoMedia.muted = media.options.mute === '1';\n            }\n\n            if (Boolean(media.options['scaletype'])) {\n                if (media.options.scaletype === 'stretch') {\n                    $videoMedia.style.objectFit = 'fill';\n                }\n            }\n            $videoMedia.playsInline = true;\n\n            if (media.loop) {\n                $videoMedia.loop = true;\n            }\n\n            return $videoMedia;\n        },\n        init() {\n            const $videoMedia = document.getElementById(getMediaId(media)) as HTMLVideoElement;\n\n            if ($videoMedia) {\n                $videoMedia.onloadstart = () => {\n                    console.log(`${capitalizeStr(media.mediaType)} for media > ${media.id} has started loading data . . .`);\n                };\n                $videoMedia.onloadeddata = () => {\n                    if ($videoMedia.readyState >= 2) {\n                        console.log(`${capitalizeStr(media.mediaType)} data for media > ${media.id} has been fully loaded . . .`);\n                    }\n                };\n                $videoMedia.oncanplay = () => {\n                    console.log(`${capitalizeStr(media.mediaType)} for media > ${media.id} can be played . . .`);\n        \n                    const videoPlayPromise = $videoMedia.play();\n        \n                    if (videoPlayPromise !== undefined) {\n                        videoPlayPromise.then(() => {\n                            console.log('autoplay started . . .');\n                            // Autoplay restarted\n                        }).catch(error => {\n                            $videoMedia.muted = true;\n                            $videoMedia.play();\n                        });\n                    }\n                };\n                $videoMedia.onplaying = () => {\n                    console.log(`${capitalizeStr(media.mediaType)} for media > ${media.id} is now playing . . .`);\n                };\n\n                if (media.duration === 0) {\n                    $videoMedia.ondurationchange = () => {\n                        console.log('Showing Media ' + media.id + ' for ' + $videoMedia.duration + 's of Region ' + media.region.regionId);\n                    };\n                    $videoMedia.onended = () => {\n                        console.log(`${capitalizeStr(media.mediaType)} for media > ${media.id} has ended playing . . .`);\n                        media.emitter?.emit('end', media);\n                    };\n                }\n            }\n        }\n    }\n\n    return videoMediaObject;\n}\n","/*\r\n * Copyright (C) 2024 Xibo Signage Ltd\r\n *\r\n * Xibo - Digital Signage - https://www.xibosignage.com\r\n *\r\n * This file is part of Xibo.\r\n *\r\n * Xibo is free software: you can redistribute it and/or modify\r\n * it under the terms of the GNU Lesser General Public License as published by\r\n * the Free Software Foundation, either version 3 of the License, or\r\n * any later version.\r\n *\r\n * Xibo is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n * GNU Lesser General Public License for more details.\r\n *\r\n * You should have received a copy of the GNU Lesser General Public License\r\n * along with Xibo.  If not, see <http://www.gnu.org/licenses/>.\r\n */\r\nimport {IMedia} from '../../Types/Media';\r\nimport {getMediaId} from '../Generators';\r\n\r\nexport default function ObjectMedia(media: IMedia) {\r\n    const objMediaObject = {\r\n        prepare($objectMedia: HTMLObjectElement) {\r\n            $objectMedia.setAttribute('width', `${media.divWidth}`);\r\n            $objectMedia.setAttribute('height', `${media.divHeight}`);\r\n            $objectMedia.setAttribute('type', `video/wmv`);\r\n\r\n            return $objectMedia;\r\n        },\r\n        init() {\r\n            const $objMedia = document.getElementById(getMediaId(media)) as HTMLObjectElement;\r\n\r\n            if ($objMedia) {\r\n                console.log({\r\n                    $objMedia,\r\n                });\r\n            }\r\n        },\r\n\r\n    };\r\n\r\n    return objMediaObject;\r\n}","/*\r\n * Copyright (C) 2024 Xibo Signage Ltd\r\n *\r\n * Xibo - Digital Signage - https://www.xibosignage.com\r\n *\r\n * This file is part of Xibo.\r\n *\r\n * Xibo is free software: you can redistribute it and/or modify\r\n * it under the terms of the GNU Lesser General Public License as published by\r\n * the Free Software Foundation, either version 3 of the License, or\r\n * any later version.\r\n *\r\n * Xibo is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n * GNU Lesser General Public License for more details.\r\n *\r\n * You should have received a copy of the GNU Lesser General Public License\r\n * along with Xibo.  If not, see <http://www.gnu.org/licenses/>.\r\n */\r\nimport { createNanoEvents } from \"nanoevents\";\r\nimport { OptionsType } from '../../Types/Layout';\r\nimport { IRegion } from '../../Types/Region';\r\nimport { IMedia, initialMedia } from '../../Types/Media';\r\nimport {fetchJSON, getFileExt, getMediaId, nextId, preloadMediaBlob} from '../Generators';\r\nimport { TransitionElementOptions, compassPoints, flyTransitionKeyframes, transitionElement } from '../Transitions';\r\nimport VideoMedia from './VideoMedia';\r\nimport AudioMedia from './AudioMedia';\r\nimport {composeResourceUrlByPlatform, getDataBlob} from \"../Generators/Generators\";\r\nimport {IXlr} from \"../../Types/XLR\";\r\nimport ObjectMedia from \"./ObjectMedia\";\r\n\r\nexport interface IMediaEvents {\r\n    start: (media: IMedia) => void;\r\n    end: (media: IMedia) => void;\r\n}\r\n\r\nexport default function Media(\r\n    region: IRegion,\r\n    mediaId: string,\r\n    xml: Element,\r\n    options: OptionsType,\r\n    xlr: IXlr,\r\n) {\r\n    const props = {\r\n        region: region,\r\n        mediaId: mediaId,\r\n        xml: xml,\r\n        options: options,\r\n    };\r\n    let mediaTimer: string | number | NodeJS.Timeout | null | undefined = null;\r\n    let mediaTimeCount = 0;\r\n    const emitter = createNanoEvents<IMediaEvents>();\r\n    const mediaObject: IMedia = {\r\n        ...initialMedia,\r\n        ...props,\r\n    };\r\n    const startMediaTimer = (media: IMedia) => {\r\n        mediaTimer = setInterval(() => {\r\n            mediaTimeCount++;\r\n            if (mediaTimeCount > media.duration) {\r\n                media.emitter?.emit('end', media);\r\n            }\r\n        }, 1000);\r\n        console.log('Showing Media ' + media.id + ' for ' + media.duration + 's of Region ' + media.region.regionId);\r\n    };\r\n\r\n    emitter.on('start', function(media) {\r\n        if (media.mediaType === 'video') {\r\n\r\n            if (getFileExt(media.uri) === 'wmv') {\r\n                ObjectMedia(media).init();\r\n            } else {\r\n                VideoMedia(media).init();\r\n            }\r\n\r\n            if (media.duration > 0) {\r\n                startMediaTimer(media);\r\n            }\r\n        } else if (media.mediaType === 'audio') {\r\n            AudioMedia(media).init();\r\n            if (media.duration > 0) {\r\n                startMediaTimer(media);\r\n            }\r\n        } else {\r\n            startMediaTimer(media);\r\n        }\r\n    });\r\n\r\n    emitter.on('end', function(media) {\r\n        if (mediaTimer) {\r\n            clearInterval(mediaTimer);\r\n            mediaTimeCount = 0;\r\n        }\r\n\r\n        media.region.playNextMedia();\r\n    });\r\n\r\n    mediaObject.init = function() {\r\n        const self = mediaObject;\r\n        self.id = props.mediaId;\r\n        self.fileId = self.xml?.getAttribute('fileId') || '';\r\n        self.idCounter = nextId(props.options);\r\n        self.containerName = `M-${self.id}-${self.idCounter}`;\r\n        self.iframeName = `${self.containerName}-iframe`;\r\n        self.mediaType = self.xml?.getAttribute('type') || '';\r\n        self.render = self.xml?.getAttribute('render') || '';\r\n        self.duration = parseInt(self.xml?.getAttribute('duration') as string) || 0;\r\n        self.options = { ...props.options, mediaId };\r\n\r\n        const $mediaIframe = document.createElement('iframe');\r\n        const mediaOptions = self.xml?.getElementsByTagName('options');\r\n\r\n        if (mediaOptions) {\r\n            for (let _options of Array.from(mediaOptions)) {\r\n                // Get options\r\n                const _mediaOptions = _options.children;\r\n                for (let mediaOption of Array.from(_mediaOptions)) {\r\n                    self.options[mediaOption.nodeName.toLowerCase()] = mediaOption.textContent;\r\n                }\r\n            }\r\n        }\r\n\r\n        // Check for options.uri and add it to media\r\n        if (Boolean(self.options['uri'])) {\r\n            self.uri = self.options['uri'];\r\n        }\r\n\r\n        // Show in fullscreen?\r\n        if(self.options.showfullscreen === \"1\") {\r\n            // Set dimensions as the layout ones\r\n            self.divWidth = self.region.layout.sWidth;\r\n            self.divHeight = self.region.layout.sHeight;\r\n        } else {\r\n            // Set dimensions as the region ones\r\n            self.divWidth = self.region.sWidth;\r\n            self.divHeight = self.region.sHeight;\r\n        }\r\n\r\n        $mediaIframe.scrolling = 'no';\r\n        $mediaIframe.id = self.iframeName;\r\n        $mediaIframe.width = `${self.divWidth}px`;\r\n        $mediaIframe.height = `${self.divHeight}px`;\r\n        $mediaIframe.style.cssText = `border: 0; visibility: hidden;`;\r\n\r\n        const $mediaId = getMediaId(self);\r\n        let $media = document.getElementById($mediaId);\r\n\r\n        if ($media === null) {\r\n            if (self.mediaType === 'video') {\r\n                $media = document.createElement('video');\r\n\r\n                if (getFileExt(self.uri) === 'wmv') {\r\n                    $media = document.createElement('object');\r\n                }\r\n            } else if (self.mediaType === 'audio') {\r\n                $media = new Audio();\r\n            } else {\r\n                $media = document.createElement('div');\r\n            }\r\n        \r\n            $media.id = $mediaId;\r\n        }\r\n\r\n        $media.className = 'media--item';\r\n\r\n        /* Scale the Content Container */\r\n        $media.style.cssText = `\r\n            display: none;\r\n            width: ${self.divWidth}px;\r\n            height: ${self.divHeight}px;\r\n            position: absolute;\r\n            background-size: contain;\r\n            background-repeat: no-repeat;\r\n            background-position: center;\r\n        `;\r\n\r\n        const $region = document.getElementById(`${self.region.containerName}`);\r\n\r\n        const resourceUrlParams: any = {\r\n            ...xlr.config.config,\r\n            regionOptions: self.region.options,\r\n            layoutId: self.region.layout.layoutId,\r\n            regionId: self.region.id,\r\n            mediaId: self.id,\r\n            fileId: self.fileId,\r\n            scaleFactor: self.region.layout.scaleFactor,\r\n            uri: self.uri,\r\n        };\r\n\r\n        if (self.mediaType === 'image' || self.mediaType === 'video') {\r\n            resourceUrlParams.mediaType = self.mediaType;\r\n        }\r\n\r\n        const tmpUrl = composeResourceUrlByPlatform(xlr.config.platform, resourceUrlParams);\r\n\r\n        self.url = tmpUrl;\r\n\r\n        // Loop if media has loop, or if region has loop and a single media\r\n        self.loop =\r\n            self.options['loop'] == '1' ||\r\n            (self.region.options['loop'] == '1' && self.region.totalMediaObjects == 1);\r\n\r\n        $mediaIframe.src = `${tmpUrl}&width=${self.divWidth}&height=${self.divHeight}`;\r\n\r\n        if (self.render === 'html' || self.mediaType === 'ticker' || self.mediaType === 'webpage') {\r\n            self.checkIframeStatus = true;\r\n            self.iframe = $mediaIframe;\r\n        }  else if (self.mediaType === \"image\") {\r\n            // preload.addFiles(tmpUrl);\r\n            // $media.style.cssText = $media.style.cssText.concat(`background-image: url('${tmpUrl}');`);\r\n            if (self.options['scaletype'] === 'stretch') {\r\n                $media.style.cssText = $media.style.cssText.concat(`background-size: 100% 100%;`);\r\n            } else if (self.options['scaletype'] === 'fit') {\r\n                $media.style.cssText = $media.style.cssText.concat(`background-size: cover;`);\r\n            } else {\r\n                // Center scale type, do we have align or valign?\r\n                const align = (self.options['align'] == \"\") ? \"center\" : self.options['align'];\r\n                const valign = (self.options['valign'] == \"\" || self.options['valign'] == \"middle\") ? \"center\" : self.options['valign'];\r\n                $media.style.cssText = $media.style.cssText.concat(`background-position: ${align} ${valign}`);\r\n            }\r\n        } else if (self.mediaType === 'video') {\r\n            let $videoMedia;\r\n            if (getFileExt(self.uri) === 'wmv') {\r\n                $videoMedia = ObjectMedia(self).prepare($media as HTMLObjectElement);\r\n            } else {\r\n                $videoMedia = VideoMedia(self).prepare($media as HTMLVideoElement);\r\n            }\r\n\r\n            $media = $videoMedia;\r\n        } else if (self.mediaType === 'audio') {\r\n            const $audioMedia = $media as HTMLAudioElement;\r\n\r\n            $audioMedia.preload = 'auto';\r\n            $audioMedia.textContent = 'Unsupported Audio';\r\n            $audioMedia.autoplay = true;\r\n\r\n            if (self.loop) {\r\n                $audioMedia.loop = true;\r\n            }\r\n\r\n            $media = $audioMedia;\r\n        }\r\n\r\n        // Duration is per item condition\r\n        if (self.render === 'html' || self.mediaType === 'ticker') {\r\n            /* Check if the ticker duration is based on the number of items in the feed */\r\n            if (self.options['durationisperitem'] === '1') {\r\n                const regex = new RegExp('<!-- NUMITEMS=(.*?) -->');\r\n\r\n                (async () => {\r\n                    let html = await fetchJSON(`${tmpUrl}&width=${self.divWidth}&height=${self.divHeight}`);\r\n                    console.log({html});\r\n                    const res = regex.exec(html);\r\n\r\n                    if (res !== null) {\r\n                        self.duration = parseInt(String(self.duration)) * parseInt(res[1]);\r\n                    }\r\n                })();\r\n            }\r\n        }\r\n\r\n        // Check if the media has fade-in/out transitions\r\n        if (Boolean(self.options['transin']) && Boolean(self.options['transinduration'])) {\r\n            const transInDuration = Number(self.options.transinduration);\r\n            const fadeInTrans = transitionElement('fadeIn', { duration: transInDuration });\r\n            $media.animate(fadeInTrans.keyframes, fadeInTrans.timing);\r\n        }\r\n\r\n        // Add media to the region\r\n        // Second media if exists, will be off-canvas\r\n        // All added media will be hidden by default\r\n        // It will start showing when region.nextMedia() function is called\r\n\r\n        // When there's only 1 item and loop = false, don't remove the item but leave it at its last state\r\n        // For image, and only 1 item, it should still have the transition for next state\r\n        // Add conditions for video duration being 0 or 1 and also the loop property\r\n        // For video url, we have to create a URL out of the XLF video URL\r\n\r\n        /**\r\n         * @DONE\r\n         * Case 1: Video duration = 0, this will play the video for its entire duration\r\n         * Case 2: Video duration is set > 0 and loop = false\r\n         * E.g. Set duration = 100s, video duration = 62s\r\n         * the video will play until 62s and will stop to its last frame until 100s\r\n         * After 100s, it will expire\r\n         * Case 3: Video duration is set > 0 and loop = true\r\n         * E.g. Set duration = 100s, video duration = 62s, loop = true\r\n         * the video will play until 62s and will loop through until the remaining 38s\r\n         * to complete the 100s set duration\r\n         */\r\n\r\n        // Add html node to media for\r\n        self.html = $media;\r\n    };\r\n\r\n    mediaObject.run = function() {\r\n        const self = mediaObject;\r\n        let transInDuration = 1;\r\n        let transInDirection: compassPoints = 'E';\r\n\r\n        if (Boolean(self.options['transinduration'])) {\r\n            transInDuration = Number(self.options.transinduration);\r\n        }\r\n\r\n        if (Boolean(self.options['transindirection'])) {\r\n            transInDirection = self.options.transindirection;\r\n        }\r\n\r\n        let defaultTransInOptions: TransitionElementOptions = {duration: transInDuration};\r\n        let transIn = transitionElement('defaultIn', {duration: defaultTransInOptions.duration});\r\n        \r\n        if (Boolean(self.options['transin'])) {\r\n            let transInName = self.options['transin'];\r\n\r\n            if (transInName === 'fly') {\r\n                transInName = `${transInName}In`;\r\n                defaultTransInOptions.keyframes = flyTransitionKeyframes({\r\n                    trans: 'in',\r\n                    direction: transInDirection,\r\n                    height: self.divHeight,\r\n                    width: self.divWidth,\r\n                });\r\n            }\r\n\r\n            transIn = transitionElement(transInName, defaultTransInOptions);\r\n        }\r\n\r\n        const showCurrentMedia = async () => {\r\n            let $mediaId = getMediaId(self);\r\n            let $media = document.getElementById($mediaId);\r\n            const isCMS = xlr.config.platform === 'CMS';\r\n\r\n            if ($media === null) {\r\n                $media = getNewMedia();\r\n            }\r\n\r\n            if ($media !== null) {\r\n                $media.style.setProperty('display', 'block');\r\n\r\n                if (Boolean(self.options['transin'])) {\r\n                    $media.animate(transIn.keyframes, transIn.timing);\r\n                }\r\n\r\n                if (self.mediaType === 'image' && self.url !== null) {\r\n                    ($media as HTMLImageElement).style\r\n                        .setProperty(\r\n                            'background-image',\r\n                            `url(${!isCMS ? self.url : await getDataBlob(self.url)}`\r\n                        );\r\n                } else if (self.mediaType === 'video' && self.url !== null) {\r\n                    if (getFileExt(self.uri) === 'wmv') {\r\n                        ($media as HTMLObjectElement)\r\n                            .setAttribute('data', await preloadMediaBlob(self.url, self.mediaType));\r\n                    } else {\r\n                        ($media as HTMLVideoElement).src =\r\n                            isCMS ? await preloadMediaBlob(self.url, self.mediaType) : self.url;\r\n                    }\r\n                } else if (self.mediaType === 'audio' && self.url !== null) {\r\n                    ($media as HTMLAudioElement).src =\r\n                        isCMS ? await preloadMediaBlob(self.url, self.mediaType) : self.url;\r\n                } else if ((self.render === 'html' || self.mediaType === 'webpage') &&\r\n                    self.iframe && self.checkIframeStatus\r\n                ) {\r\n                    // Set state as false ( for now )\r\n                    self.ready = false;\r\n\r\n                    // Append iframe\r\n                    $media.innerHTML = '';\r\n                    $media.appendChild(self.iframe as Node);\r\n\r\n                    // On iframe load, set state as ready to play full preview\r\n                    (self.iframe) && self.iframe.addEventListener('load', function(){\r\n                        self.ready = true;\r\n                        if (self.iframe) {\r\n                            const iframeStyles = self.iframe.style.cssText;\r\n                            self.iframe.style.cssText = iframeStyles?.concat('visibility: visible;');\r\n                        }\r\n                    });\r\n                }\r\n\r\n                self.emitter?.emit('start', self);\r\n            }\r\n        };\r\n        const getNewMedia = (): HTMLElement | null => {\r\n            const $region = document.getElementById(`${self.region.containerName}`);\r\n            // This function is for checking whether\r\n            // the region still has to show a media item\r\n            // when another region is not finished yet\r\n            if (self.region.complete && !self.region.layout.allEnded) {\r\n                // Add currentMedia to the region\r\n\r\n                ($region) && $region.insertBefore(self.html as Node, $region.lastElementChild);\r\n\r\n                return self.html as HTMLElement;\r\n            }\r\n\r\n            return null;\r\n        };\r\n\r\n        showCurrentMedia();\r\n    };\r\n\r\n    mediaObject.stop = async function() {\r\n        const self = mediaObject;\r\n        const $media = document.getElementById(getMediaId(self));\r\n\r\n        if ($media) {\r\n            $media.style.display = 'none';\r\n            $media.remove();\r\n        }\r\n    };\r\n\r\n    \r\n    mediaObject.on = function<E extends keyof IMediaEvents>(event: E, callback: IMediaEvents[E]) {\r\n        return emitter.on(event, callback);\r\n    };\r\n\r\n    mediaObject.emitter = emitter;\r\n\r\n    mediaObject.init();\r\n\r\n    return mediaObject;\r\n}","/*\n * Copyright (C) 2024 Xibo Signage Ltd\n *\n * Xibo - Digital Signage - https://www.xibosignage.com\n *\n * This file is part of Xibo.\n *\n * Xibo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Lesser General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * any later version.\n *\n * Xibo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Lesser General Public License for more details.\n *\n * You should have received a copy of the GNU Lesser General Public License\n * along with Xibo.  If not, see <http://www.gnu.org/licenses/>.\n */\nimport { IMedia } from '../../Types/Media';\nimport { capitalizeStr, getMediaId } from '../Generators';\n\nimport './media.css';\n\nexport default function AudioMedia(media: IMedia) {\n    const audioMediaObject = {\n        init() {\n            const $audioMedia = document.getElementById(getMediaId(media)) as HTMLAudioElement;\n            let $playBtn: HTMLButtonElement | null = null;\n\n            if ($audioMedia) {\n                $audioMedia.onloadstart = () => {\n                    console.log(`${capitalizeStr(media.mediaType)} for media > ${media.id} has started loading data . . .`);\n                };\n                $audioMedia.onloadeddata = () => {\n                    if ($audioMedia.readyState >= 2) {\n                        console.log(`${capitalizeStr(media.mediaType)} data for media > ${media.id} has been fully loaded . . .`);\n                    }\n                };\n                $audioMedia.oncanplay = () => {\n                    console.log(`${capitalizeStr(media.mediaType)} for media > ${media.id} can be played . . .`);\n                };\n                $audioMedia.onplaying = () => {\n                    console.log(`${capitalizeStr(media.mediaType)} for media > ${media.id} is now playing . . .`);\n\n                    if ($playBtn !== null) {\n                        $playBtn.remove();\n                    }\n                };\n\n                const audioPlayPromise = $audioMedia.play();\n    \n                if (audioPlayPromise !== undefined) {\n                    audioPlayPromise.then(() => {\n                        console.log('autoplay started . . .');\n                        // Autoplay restarted\n                    }).catch(error => {\n                        if (error.name === 'NotAllowedError') {\n                            // Let's show a play audio button\n                            $playBtn = document.createElement('button');\n\n                            $playBtn.classList.add('play-audio-btn');\n                            $playBtn.textContent = 'Play Audio';\n                            $playBtn.addEventListener('click', () => {\n                                $audioMedia.muted = false;\n                                $audioMedia.play();\n                            });\n                            $audioMedia.parentNode?.insertBefore($playBtn, $audioMedia.nextSibling);\n                        }\n                    });\n                }\n                if (media.duration === 0) {\n                    $audioMedia.ondurationchange = () => {\n                        console.log('Showing Media ' + media.id + ' for ' + $audioMedia.duration + 's of Region ' + media.region.regionId);\n                    };\n                    $audioMedia.onended = () => {\n                        console.log(`${capitalizeStr(media.mediaType)} for media > ${media.id} has ended playing . . .`);\n                        media.emitter?.emit('end', media);\n                    };\n                }\n            }\n        },\n    };\n\n    return audioMediaObject;\n}\n","/*\r\n * Copyright (C) 2024 Xibo Signage Ltd\r\n *\r\n * Xibo - Digital Signage - https://www.xibosignage.com\r\n *\r\n * This file is part of Xibo.\r\n *\r\n * Xibo is free software: you can redistribute it and/or modify\r\n * it under the terms of the GNU Lesser General Public License as published by\r\n * the Free Software Foundation, either version 3 of the License, or\r\n * any later version.\r\n *\r\n * Xibo is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n * GNU Lesser General Public License for more details.\r\n *\r\n * You should have received a copy of the GNU Lesser General Public License\r\n * along with Xibo.  If not, see <http://www.gnu.org/licenses/>.\r\n */\r\nimport {createNanoEvents} from 'nanoevents';\r\nimport {\r\n    GetLayoutParamType,\r\n    GetLayoutType,\r\n    ILayout,\r\n    initialLayout,\r\n    OptionsType,\r\n} from '../../Types/Layout';\r\nimport { IXlr } from '../../Types/XLR';\r\nimport { nextId } from '../Generators';\r\nimport { Region } from '../Region';\r\n\r\nimport './layout.css';\r\nimport {composeBgUrlByPlatform, getIndexByLayoutId} from '../Generators/Generators';\r\n\r\nconst playAgainClickHandle = function(ev: { preventDefault: () => void; }) {\r\n    ev.preventDefault();\r\n    history.go(0);\r\n};\r\n\r\nexport function initRenderingDOM(targetContainer: Element | null) {\r\n    let _targetContainer = targetContainer;\r\n    const previewPlayer = document.createElement('div');\r\n    const previewScreen = document.createElement('div');\r\n    const endPlay = document.createElement('div');\r\n    const playAgainLink = document.createElement('a');\r\n\r\n    // Preview player\r\n    previewPlayer.className = 'player-preview';\r\n    previewPlayer.id = 'player_container';\r\n\r\n    // Preview screen\r\n    previewScreen.className = 'screen-preview';\r\n    previewScreen.id = 'screen_container';\r\n\r\n    // Ended play\r\n    endPlay.className = 'preview-ended';\r\n    endPlay.id = 'play_ended';\r\n    endPlay.style.display = 'none';\r\n\r\n    // Play again link\r\n    playAgainLink.id = 'play_back_preview';\r\n    playAgainLink.className = 'play-back-preview';\r\n    playAgainLink.style.cssText = 'text-decoration: none; color: #ffffff;';\r\n    playAgainLink.innerHTML = 'Play again?';\r\n    playAgainLink.removeEventListener('click', playAgainClickHandle);\r\n    playAgainLink.addEventListener('click', playAgainClickHandle);\r\n\r\n    if (!_targetContainer) {\r\n        _targetContainer = document.body;\r\n    }\r\n\r\n    if (_targetContainer) {\r\n        if (_targetContainer.querySelector('#player_container') === null) {\r\n            _targetContainer.insertBefore(previewPlayer, _targetContainer.firstChild);\r\n\r\n            if (previewPlayer.querySelector('#screen_container') === null) {\r\n                previewPlayer.appendChild(previewScreen);\r\n            }\r\n\r\n            if (previewPlayer.querySelector('#play_ended') === null) {\r\n                previewPlayer.appendChild(endPlay);\r\n\r\n                if (endPlay.querySelector('a') === null) {\r\n                    endPlay.appendChild(playAgainLink);\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nexport async function getXlf(layoutOptions: OptionsType) {\r\n    let apiHost = window.location.origin;\r\n\r\n    let xlfUrl = apiHost + layoutOptions.xlfUrl;\r\n    let fetchOptions: RequestInit = {};\r\n\r\n    if (layoutOptions.platform === 'CMS') {\r\n        xlfUrl = apiHost + layoutOptions.xlfUrl;\r\n        fetchOptions.mode = 'no-cors';\r\n    } else if (layoutOptions.platform === 'chromeOS') {\r\n        xlfUrl = layoutOptions.xlfUrl;\r\n        fetchOptions.mode = 'cors';\r\n        fetchOptions.headers = {\r\n            'Content-Type': 'text/xml',\r\n        };\r\n    } else if (layoutOptions.platform !== 'CMS' && layoutOptions.appHost !== null) {\r\n        xlfUrl = layoutOptions.appHost + layoutOptions.xlfUrl;\r\n    }\r\n\r\n    const res = await fetch(xlfUrl);\r\n\r\n    return await res.text();\r\n}\r\n\r\nexport function handleAxiosError(error: any, message?: string) {\r\n    console.error(error);\r\n    if (error.response.status == 500) {\r\n        // SOAP responses are always 500's\r\n        // Return the body\r\n        throw new Error(error.response.data);\r\n    } else {\r\n        throw new Error(message || 'Unknown Error');\r\n    }\r\n}\r\n\r\nexport function getLayout(params: GetLayoutParamType): GetLayoutType {\r\n    let _currentLayout = undefined;\r\n    let _nextLayout = undefined;\r\n    let {\r\n        inputLayouts,\r\n        currentLayout,\r\n        nextLayout,\r\n        currentLayoutIndex: currLayoutIndx\r\n    } = params.xlr;\r\n    const hasLayout = inputLayouts.length > 0;\r\n    let currentLayoutIndex = currLayoutIndx;\r\n    let nextLayoutIndex = currentLayoutIndex + 1;\r\n\r\n    if (currentLayout === undefined && nextLayout === undefined) {\r\n        let activeLayout;\r\n        // Preview just got started\r\n        if (hasLayout) {\r\n            let nextLayoutTemp = {...initialLayout};\r\n            activeLayout = inputLayouts[currentLayoutIndex];\r\n            _currentLayout = {...initialLayout, ...activeLayout};\r\n\r\n            if (inputLayouts.length > 1) {\r\n                nextLayoutTemp = {...nextLayoutTemp, ...inputLayouts[nextLayoutIndex]};\r\n                _nextLayout = nextLayoutTemp;\r\n            } else {\r\n                _nextLayout = _currentLayout;\r\n            }\r\n\r\n            _currentLayout.id = activeLayout.layoutId;\r\n\r\n            if (nextLayoutTemp) {\r\n                _nextLayout.id = nextLayoutTemp.layoutId;\r\n            }\r\n        }\r\n    } else {\r\n        if (hasLayout) {\r\n            _currentLayout = nextLayout;\r\n\r\n            currentLayoutIndex = getIndexByLayoutId(inputLayouts, _currentLayout?.layoutId).index as number;\r\n            nextLayoutIndex = currentLayoutIndex + 1;\r\n\r\n            if (inputLayouts.length > 1 && nextLayoutIndex < inputLayouts.length) {\r\n                if (Boolean(params.xlr.layouts[nextLayoutIndex])) {\r\n                    _nextLayout = params.xlr.layouts[nextLayoutIndex];\r\n                } else {\r\n                    _nextLayout = {...initialLayout, ...inputLayouts[nextLayoutIndex]};\r\n                }\r\n            }\r\n\r\n            // If _nextLayout is undefined, then we go back to first layout\r\n            if (_nextLayout === undefined) {\r\n                _nextLayout = params.xlr.layouts[0];\r\n            }\r\n        }\r\n    }\r\n\r\n    return {\r\n        currentLayoutIndex,\r\n        inputLayouts: params.xlr.inputLayouts,\r\n        current: _currentLayout,\r\n        next: _nextLayout,\r\n    }\r\n}\r\n\r\nexport interface ILayoutEvents {\r\n    start: (layout: ILayout) => void;\r\n    end: (layout: ILayout) => void;\r\n}\r\n\r\nexport default function Layout(\r\n    data: Document | null,\r\n    options: OptionsType,\r\n    xlr: IXlr,\r\n    layout?: ILayout\r\n) {\r\n    const props = {\r\n        data: data,\r\n        options: options,\r\n        layout: layout || initialLayout,\r\n    }\r\n    const emitter = createNanoEvents<ILayoutEvents>();\r\n\r\n    emitter.on('start', (layout) => {\r\n        layout.done = false;\r\n        console.log('Layout start emitted > Layout ID > ', layout.id);\r\n    });\r\n\r\n    emitter.on('end', (layout) => {\r\n        console.log('Ending layout with ID of > ', layout.layoutId);\r\n        layout.done = true;\r\n        /* Remove layout that has ended */\r\n        const $layout = document.getElementById(layout.containerName);\r\n\r\n        console.log({$layout});\r\n\r\n        if ($layout !== null) {\r\n            $layout.remove();\r\n        }\r\n\r\n        if (xlr.config.platform !== 'CMS') {\r\n            // Transition next layout to current layout and prepare next layout if exist\r\n            xlr.prepareLayouts().then((parent) => {\r\n                xlr.playSchedules(parent);\r\n            });\r\n        }\r\n    });\r\n\r\n    const layoutObject: ILayout = {\r\n        ...props.layout,\r\n        options: props.options,\r\n        emitter,\r\n    };\r\n\r\n    layoutObject.on = function<E extends keyof ILayoutEvents>(event: E, callback: ILayoutEvents[E]) {\r\n        return emitter.on(event, callback);\r\n    };\r\n    layoutObject.run = function() {\r\n        const layout = layoutObject;\r\n        const $layoutContainer = document.getElementById(`${layout.containerName}`);\r\n        const $splashScreen = document.getElementById(`splash_${layout.id}`);\r\n\r\n        if ($layoutContainer) {\r\n            $layoutContainer.style.display = 'block';\r\n        }\r\n\r\n        if ($splashScreen) {\r\n            $splashScreen.style.display = 'none';\r\n        }\r\n\r\n        console.log('Layout running > Layout ID > ', layout.id);\r\n        console.log('Layout Regions > ', layout.regions);\r\n        for (let i = 0; i < layout.regions.length; i++) {\r\n            // playLog(4, \"debug\", \"Running region \" + self.regions[i].id, false);\r\n            layout.regions[i].run();\r\n        }\r\n    };\r\n\r\n    layoutObject.parseXlf = function() {\r\n        const layout = layoutObject;\r\n        const {data, options} = props;\r\n        layout.containerName = \"L\" + layout.id + \"-\" + nextId(options);\r\n        layout.regions = [];\r\n\r\n        /* Create a hidden div to show the layout in */\r\n        let $layout = document.getElementById(layout.containerName);\r\n\r\n        if ($layout === null) {\r\n            $layout = document.createElement('div');\r\n            $layout.id = layout.containerName;\r\n        }\r\n\r\n        let $screen = document.getElementById('screen_container');\r\n        ($screen) && $screen.appendChild($layout);\r\n\r\n        if ($layout) {\r\n            $layout.style.display = 'none';\r\n            $layout.style.outline = 'red solid thin';\r\n        }\r\n\r\n        layout.layoutNode = data;\r\n\r\n        /* Calculate the screen size */\r\n        layout.sw = $screen?.offsetWidth || 0;\r\n        layout.sh = $screen?.offsetHeight || 0;\r\n\r\n        layout.xw = Number(layout.layoutNode?.firstElementChild?.getAttribute('width'));\r\n        layout.xh = Number(layout.layoutNode?.firstElementChild?.getAttribute('height'));\r\n        layout.zIndex = Number(layout.layoutNode?.firstElementChild?.getAttribute('zindex')) || 0;\r\n\r\n        /* Calculate Scale Factor */\r\n        layout.scaleFactor = Math.min((layout.sw / layout.xw), (layout.sh / layout.xh));\r\n        layout.sWidth = Math.round(layout.xw * layout.scaleFactor);\r\n        layout.sHeight = Math.round(layout.xh * layout.scaleFactor);\r\n        layout.offsetX = Math.abs(layout.sw - layout.sWidth) / 2;\r\n        layout.offsetY = Math.abs(layout.sh - layout.sHeight) / 2;\r\n\r\n        /* Scale the Layout Container */\r\n        if ($layout) {\r\n            $layout.style.width = `${layout.sWidth}px`;\r\n            $layout.style.height = `${layout.sHeight}px`;\r\n            $layout.style.position = 'absolute';\r\n            $layout.style.left = `${layout.offsetX}px`;\r\n            $layout.style.top = `${layout.offsetY}px`;\r\n        }\r\n\r\n        if ($layout && layout.zIndex !== null) {\r\n            $layout.style.zIndex = `${layout.zIndex}`;\r\n        }\r\n\r\n        /* Set the layout background */\r\n        layout.bgColor = layout.layoutNode?.firstElementChild?.getAttribute('bgcolor') || '';\r\n        layout.bgImage = layout.layoutNode?.firstElementChild?.getAttribute('background') || '';\r\n\r\n        if (!(layout.bgImage === \"\" || typeof layout.bgImage === 'undefined')) {\r\n            /* Extract the image ID from the filename */\r\n            layout.bgId = layout.bgImage.substring(0, layout.bgImage.indexOf('.'));\r\n\r\n            const bgImageUrl = composeBgUrlByPlatform(\r\n                xlr.config.platform,\r\n                {\r\n                    ...options,\r\n                    layout,\r\n                }\r\n            );\r\n\r\n            if ($layout) {\r\n                $layout.style.backgroundImage = `url(\"${bgImageUrl}\")`;\r\n                $layout.style.backgroundRepeat = 'no-repeat';\r\n                $layout.style.backgroundSize = `${layout.sWidth}px ${layout.sHeight}px`;\r\n                $layout.style.backgroundPosition = '0px 0px';\r\n            }\r\n        }\r\n\r\n        // Set the background color\r\n        if ($layout && layout.bgColor) {\r\n            $layout.style.backgroundColor = `${layout.bgColor}`;\r\n        }\r\n\r\n        // Hide if layout is not the currentLayout\r\n        if ($layout && xlr.currentLayoutId !== undefined && xlr.currentLayoutId !== layout.id) {\r\n            $layout.style.display = 'none';\r\n        }\r\n\r\n        // Create regions\r\n        const layoutRegions = Array.from(layout?.layoutNode?.getElementsByTagName('region') || []);\r\n\r\n        Array.from(layoutRegions).forEach((regionXml, indx) => {\r\n            const regionObj = Region(\r\n                layout,\r\n                regionXml,\r\n                regionXml?.getAttribute('id') || '',\r\n                options,\r\n                xlr,\r\n            );\r\n\r\n            regionObj.index = indx;\r\n            layout.regions.push(regionObj);\r\n        });\r\n    };\r\n\r\n    layoutObject.prepareLayout = function() {\r\n        layoutObject.parseXlf();\r\n    };\r\n\r\n    layoutObject.regionExpired = function() {\r\n        const self = layoutObject;\r\n        self.allExpired = true;\r\n\r\n        for (let layoutRegion of self.regions) {\r\n            if (!layoutRegion.complete) {\r\n                self.allExpired = false;\r\n            }\r\n        }\r\n\r\n        if (self.allExpired) {\r\n            self.end();\r\n        }\r\n    };\r\n\r\n    layoutObject.regionEnded = function() {\r\n        const self = layoutObject;\r\n        self.allEnded = true;\r\n        \r\n        for (var i = 0; i < self.regions.length; i++) {\r\n            if (! self.regions[i].ended) {\r\n                self.allEnded = false;\r\n            }\r\n        }\r\n        \r\n        if (self.allEnded) {\r\n            self.stopAllMedia().then(() => {\r\n                console.log('starting to end layout . . .');\r\n                if (xlr.config.platform === 'CMS') {\r\n                    const $end = document.getElementById('play_ended');\r\n                    const $preview = document.getElementById('screen_container');\r\n        \r\n                    if ($preview) {\r\n                        while($preview.firstChild) {\r\n                            $preview.removeChild($preview.firstChild);\r\n                        }\r\n        \r\n                        $preview.style.display = 'none';\r\n                    }\r\n        \r\n                    if ($end) {\r\n                        $end.style.display = 'block';\r\n                    }\r\n                }\r\n                \r\n                self.emitter?.emit('end', self);\r\n            });\r\n\r\n        }\r\n    };\r\n\r\n    layoutObject.end = function() {\r\n        console.log('Executing Layout::end and Calling Region::end ', layoutObject);\r\n\r\n        /* Ask the layout to gracefully stop running now */\r\n        for (let layoutRegion of layoutObject.regions) {\r\n            layoutRegion.end();\r\n        }\r\n    };\r\n\r\n    layoutObject.stopAllMedia = function() {\r\n        console.log('Stopping all media . . .');\r\n        return new Promise(async (resolve) => {\r\n            for(var i = 0;i < layoutObject.regions.length;i++) {\r\n                var region = layoutObject.regions[i];\r\n                for(var j = 0;j < region.mediaObjects.length;j++) {\r\n                    var media = region.mediaObjects[j];\r\n                    await media.stop();\r\n                }\r\n            }\r\n\r\n            resolve();\r\n        });\r\n    };\r\n\r\n    layoutObject.prepareLayout();\r\n\r\n    return layoutObject;\r\n}\r\n","/*\r\n * Copyright (C) 2024 Xibo Signage Ltd\r\n *\r\n * Xibo - Digital Signage - https://www.xibosignage.com\r\n *\r\n * This file is part of Xibo.\r\n *\r\n * Xibo is free software: you can redistribute it and/or modify\r\n * it under the terms of the GNU Lesser General Public License as published by\r\n * the Free Software Foundation, either version 3 of the License, or\r\n * any later version.\r\n *\r\n * Xibo is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n * GNU Lesser General Public License for more details.\r\n *\r\n * You should have received a copy of the GNU Lesser General Public License\r\n * along with Xibo.  If not, see <http://www.gnu.org/licenses/>.\r\n */\r\nimport { createNanoEvents } from \"nanoevents\";\r\nimport { ILayout, OptionsType } from '../../Types/Layout';\r\nimport { initialRegion, IRegion, IRegionEvents } from '../../Types/Region';\r\nimport { IMedia } from '../../Types/Media';\r\nimport { getMediaId, nextId } from '../Generators';\r\nimport { platform } from '../Platform';\r\nimport { Media } from '../Media';\r\nimport {\r\n    TransitionElementOptions,\r\n    TransitionNameType,\r\n    compassPoints,\r\n    flyTransitionKeyframes,\r\n    transitionElement,\r\n} from '../Transitions';\r\nimport {IXlr} from \"../../Types/XLR\";\r\n\r\nexport default function Region(\r\n    layout: ILayout,\r\n    xml: Element,\r\n    regionId: string,\r\n    options: OptionsType,\r\n    xlr: IXlr,\r\n) {\r\n    const props = {\r\n        layout: layout,\r\n        xml: xml,\r\n        regionId: regionId,\r\n        options: options,\r\n    }\r\n    const emitter = createNanoEvents<IRegionEvents>();\r\n    let regionObject: IRegion = {\r\n        ...initialRegion,\r\n        ...props,\r\n    };\r\n\r\n    regionObject.prepareRegion = function() {\r\n        const self = regionObject;\r\n        const {layout, options} = self;\r\n        self.id = props.regionId;\r\n        self.options = {...platform, ...props.options};\r\n        self.containerName = `R-${self.id}-${nextId(self.options as OptionsType & IRegion[\"options\"])}`;\r\n        self.xml = props.xml;\r\n        self.mediaObjects = [];\r\n\r\n        self.sWidth = (self.xml) && Number(self.xml?.getAttribute('width')) * layout.scaleFactor;\r\n        self.sHeight = (self.xml) && Number(self.xml?.getAttribute('height')) * layout.scaleFactor;\r\n        self.offsetX = (self.xml) && Number(self.xml?.getAttribute('left')) * layout.scaleFactor;\r\n        self.offsetY = (self.xml) && Number(self.xml?.getAttribute('top')) * layout.scaleFactor;\r\n        self.zIndex = (self.xml) && Number(self.xml?.getAttribute('zindex'));\r\n        \r\n        const regionOptions = self.xml?.getElementsByTagName('options');\r\n\r\n        if (regionOptions) {\r\n            for (let _options of Array.from(regionOptions)) {\r\n                // Get options\r\n                const _regionOptions = _options.children;\r\n                for (let regionOption of Array.from(_regionOptions)) {\r\n                    self.options[regionOption.nodeName.toLowerCase()] = regionOption.textContent;\r\n                }\r\n            }\r\n        }\r\n\r\n\r\n        let $region = document.getElementById(self.containerName);\r\n        const $layout = document.getElementById(`${self.layout.containerName}`);\r\n\r\n        if ($region === null) {\r\n            $region = document.createElement('div');\r\n            $region.id = self.containerName;\r\n        }\r\n\r\n        ($layout) && $layout.appendChild($region);\r\n\r\n        /* Scale the Layout Container */\r\n        /* Add region styles */\r\n        $region.style.cssText = `\r\n            width: ${self.sWidth}px;\r\n            height: ${self.sHeight}px;\r\n            position: absolute;\r\n            left: ${self.offsetX}px;\r\n            top: ${self.offsetY}px;\r\n            z-index: ${Math.round(self.zIndex)};\r\n        `;\r\n        $region.className = 'region--item';\r\n\r\n        /* Parse region media objects */\r\n        const regionMediaItems = Array.from(self.xml.getElementsByTagName('media'));\r\n        self.totalMediaObjects = regionMediaItems.length;\r\n\r\n        Array.from(regionMediaItems).forEach((mediaXml, indx) => {\r\n            const mediaObj = Media(\r\n                self,\r\n                mediaXml?.getAttribute('id') || '',\r\n                mediaXml,\r\n                options as OptionsType & IRegion[\"options\"],\r\n                xlr,\r\n            );\r\n\r\n            mediaObj.index = indx;\r\n            self.mediaObjects.push(mediaObj);\r\n        });\r\n\r\n        self.prepareMediaObjects();\r\n    };\r\n\r\n    regionObject.finished = function() {\r\n        const self = regionObject;\r\n        console.log('Region::finished called . . . ', self.id);\r\n        // Mark as complete\r\n        self.complete = true;\r\n        self.layout.regions[regionObject.index] = regionObject;\r\n        self.layout.regionExpired();\r\n    };\r\n\r\n    regionObject.prepareMediaObjects = function() {\r\n        const self = regionObject;\r\n        let nextMediaIndex;\r\n\r\n        if (self.mediaObjects.length > 0) {\r\n\r\n            if (self.curMedia) {\r\n                self.oldMedia = self.curMedia;\r\n            } else {\r\n                self.oldMedia = undefined;\r\n            }\r\n\r\n            if (self.currentMediaIndex >= self.mediaObjects.length) {\r\n                self.currentMediaIndex = 0;\r\n            }\r\n\r\n            self.curMedia = self.mediaObjects[self.currentMediaIndex];\r\n\r\n            nextMediaIndex = self.currentMediaIndex + 1;\r\n\r\n            if (nextMediaIndex >= self.mediaObjects.length ||\r\n                (\r\n                    !Boolean(self.mediaObjects[nextMediaIndex]) &&\r\n                    self.mediaObjects.length === 1\r\n                )\r\n            ) {\r\n                nextMediaIndex = 0;\r\n            }\r\n\r\n            if (Boolean(self.mediaObjects[nextMediaIndex])) {\r\n                self.nxtMedia = self.mediaObjects[nextMediaIndex];\r\n            }\r\n\r\n            const $region = document.getElementById(`${self.containerName}`);\r\n            // Append available media to region DOM\r\n            if (self.curMedia) {\r\n                ($region) && $region.insertBefore(self.curMedia.html as Node, $region.lastElementChild);\r\n            }\r\n\r\n            if (self.nxtMedia) {\r\n                ($region) && $region.insertBefore(self.nxtMedia.html as Node, $region.lastElementChild);\r\n            }\r\n        }\r\n    };\r\n\r\n    regionObject.run = function() {\r\n        console.log('Called Region::run > ', regionObject.id);\r\n\r\n        if (regionObject.curMedia) {\r\n            regionObject.transitionNodes(regionObject.oldMedia, regionObject.curMedia);\r\n        }\r\n    };\r\n\r\n    regionObject.transitionNodes = function(oldMedia: IMedia | undefined, newMedia: IMedia | undefined) {\r\n        const self = regionObject;\r\n        let transOutDuration = 1;\r\n        let transOutDirection: compassPoints = 'E';\r\n\r\n        if (newMedia) {\r\n            if (oldMedia && Boolean(oldMedia.options['transoutduration'])) {\r\n                transOutDuration = Number(oldMedia.options.transoutduration);\r\n            }\r\n\r\n            if (oldMedia && Boolean(oldMedia.options['transoutdirection'])) {\r\n                transOutDirection = oldMedia.options.transoutdirection;\r\n            }\r\n    \r\n            let defaultTransOutOptions: TransitionElementOptions = {duration: transOutDuration};\r\n            let transOut = transitionElement('defaultOut', {duration: defaultTransOutOptions.duration});\r\n    \r\n            let transOutName: TransitionNameType | string;\r\n            if (oldMedia && Boolean(oldMedia.options['transout'])) {\r\n                transOutName = oldMedia.options['transout'];\r\n    \r\n                if (transOutName === 'fly') {\r\n                    transOutName = `${transOutName}Out`;\r\n                    defaultTransOutOptions.keyframes = flyTransitionKeyframes({\r\n                        trans: 'out',\r\n                        direction: transOutDirection,\r\n                        height: oldMedia.divHeight,\r\n                        width: oldMedia.divWidth,\r\n                    });\r\n                }\r\n                \r\n                transOut = transitionElement(transOutName as TransitionNameType, defaultTransOutOptions);\r\n            }\r\n            \r\n            const hideOldMedia = new Promise((resolve) => {\r\n                // Hide oldMedia\r\n                if (oldMedia) {\r\n                    const $oldMedia = document.getElementById(getMediaId(oldMedia));\r\n                    if ($oldMedia) {\r\n                        const removeOldMedia = () => {\r\n                            $oldMedia.style.setProperty('display', 'none');\r\n                            $oldMedia.remove();\r\n                        };\r\n\r\n                        let oldMediaAnimate: any;\r\n                        if (Boolean(oldMedia.options['transout'])) {\r\n                            oldMediaAnimate = $oldMedia.animate(transOut.keyframes, transOut.timing);\r\n                        }\r\n\r\n                        if (Boolean(oldMedia.options['transout']) && self.totalMediaObjects > 1) {\r\n                            if (transOutName === 'flyOut') {\r\n                                // Reset last item to original position and state\r\n                                oldMediaAnimate ? oldMediaAnimate.finished\r\n                                    .then(() => {\r\n                                        resolve(true);\r\n                                        oldMediaAnimate?.effect?.updateTiming({fill: 'none'});\r\n                                        removeOldMedia();\r\n                                    }) : undefined;\r\n                            } else {\r\n                                setTimeout(removeOldMedia, transOutDuration / 2);\r\n                                resolve(true);\r\n                            }\r\n                        } else {\r\n                            removeOldMedia();\r\n                            // Resolve this right away\r\n                            // As a result, the transition between two media object\r\n                            // seems like a cross-over\r\n                            resolve(true);\r\n\r\n                        }\r\n                    }\r\n                }\r\n            });\r\n    \r\n            if (oldMedia) {\r\n                hideOldMedia.then((isDone) => {\r\n                    if (isDone) {\r\n                        newMedia.run();\r\n                    }\r\n                });\r\n            } else {\r\n                newMedia.run();\r\n            }\r\n        }\r\n    };\r\n\r\n    regionObject.playNextMedia = function() {\r\n        const self = regionObject;\r\n\r\n        /* The current media has finished running */\r\n        if (self.ended) {\r\n            return;\r\n        }\r\n\r\n        if (self.currentMediaIndex === self.mediaObjects.length - 1) {\r\n            self.finished();\r\n\r\n            if (self.layout.allEnded) {\r\n                return;\r\n            }\r\n        }\r\n\r\n        // When the region has completed and when currentMedia is html\r\n        // Then, preserve the currentMedia state\r\n        if (self.complete &&\r\n            self.curMedia?.render === 'html'\r\n        ) {\r\n            return;\r\n        }\r\n\r\n        // When the region has completed and mediaObjects.length = 1\r\n        // and curMedia.loop = false, then put the media on\r\n        // its current state\r\n        if (self.complete && self.mediaObjects.length === 1 &&\r\n            self.curMedia?.render !== 'html' &&\r\n            self.curMedia?.mediaType === 'image' &&\r\n            !self.curMedia?.loop\r\n        ) {\r\n            return;\r\n        }\r\n\r\n        self.currentMediaIndex = self.currentMediaIndex + 1;\r\n        self.prepareMediaObjects();\r\n\r\n        self.transitionNodes(self.oldMedia, self.curMedia);\r\n    };\r\n    \r\n    regionObject.end = function() {\r\n        const self = regionObject;\r\n        self.ending = true;\r\n        /* The Layout has finished running */\r\n        /* Do any region exit transition then clean up */\r\n        self.layout.regions[self.index] = self;\r\n\r\n        console.log('Calling Region::end ', self);\r\n        self.exitTransition();\r\n    };\r\n\r\n    regionObject.exitTransition = function() {\r\n        const self = regionObject;\r\n        /* TODO: Actually implement region exit transitions */\r\n        const $region = document.getElementById(`${self.containerName}`);\r\n\r\n        if ($region) {\r\n            $region.style.display = 'none';\r\n        }\r\n\r\n        console.log('Called Region::exitTransition ', self.id);\r\n\r\n        self.exitTransitionComplete();\r\n    };\r\n\r\n    regionObject.exitTransitionComplete = function() {\r\n        const self = regionObject;\r\n        console.log('Called Region::exitTransitionComplete ', self.id);\r\n        self.ended = true;\r\n        self.layout.regions[self.index] = self;\r\n        self.layout.regionEnded();\r\n    };\r\n\r\n    regionObject.on = function<E extends keyof IRegionEvents>(event: E, callback: IRegionEvents[E]) {\r\n        return emitter.on(event, callback);\r\n    };\r\n\r\n    regionObject.emitter = emitter;\r\n\r\n    regionObject.prepareRegion();\r\n\r\n    return regionObject;\r\n}","/*\r\n * Copyright (C) 2024 Xibo Signage Ltd\r\n *\r\n * Xibo - Digital Signage - https://www.xibosignage.com\r\n *\r\n * This file is part of Xibo.\r\n *\r\n * Xibo is free software: you can redistribute it and/or modify\r\n * it under the terms of the GNU Lesser General Public License as published by\r\n * the Free Software Foundation, either version 3 of the License, or\r\n * any later version.\r\n *\r\n * Xibo is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n * GNU Lesser General Public License for more details.\r\n *\r\n * You should have received a copy of the GNU Lesser General Public License\r\n * along with Xibo.  If not, see <http://www.gnu.org/licenses/>.\r\n */\r\nimport {ILayout, InputLayoutType, OptionsType} from \"../Layout/Layout.types\";\r\nimport {platform} from \"../../Modules/Platform/Platform\";\r\n\r\nexport type PrepareLayoutsType = {\r\n    moveNext?: boolean;\r\n};\r\n\r\nexport enum ELayoutType {\r\n    CURRENT,\r\n    NEXT,\r\n}\r\n\r\nexport interface IXlr {\r\n    inputLayouts: InputLayoutType[],\r\n    config: OptionsType,\r\n    layouts: ILayout[],\r\n    currentLayoutIndex: number;\r\n    currentLayoutId: number | null;\r\n    currentLayout: ILayout | undefined;\r\n    nextLayout: ILayout | undefined;\r\n    bootstrap(): void;\r\n    init(): Promise<IXlr>;\r\n    playSchedules(xlr: IXlr): void;\r\n    prepareLayoutXlf(inputLayout: ILayout | undefined): Promise<ILayout>;\r\n    prepareLayouts(): Promise<IXlr>;\r\n}\r\n\r\nexport const initialXlr: IXlr = {\r\n    inputLayouts: [],\r\n    config: platform,\r\n    layouts: [],\r\n    currentLayoutIndex: 0,\r\n    currentLayoutId: null,\r\n    currentLayout: undefined,\r\n    nextLayout: undefined,\r\n    bootstrap() {\r\n    },\r\n    init() {\r\n        return Promise.resolve(<IXlr>{});\r\n    },\r\n    playSchedules() {\r\n    },\r\n    prepareLayoutXlf(inputLayout: ILayout | undefined): Promise<ILayout> {\r\n        return Promise.resolve(<ILayout>{});\r\n    },\r\n    prepareLayouts(): Promise<IXlr> {\r\n        return Promise.resolve(<IXlr>{});\r\n    }\r\n};\r\n","/*\r\n * Copyright (C) 2024 Xibo Signage Ltd\r\n *\r\n * Xibo - Digital Signage - https://www.xibosignage.com\r\n *\r\n * This file is part of Xibo.\r\n *\r\n * Xibo is free software: you can redistribute it and/or modify\r\n * it under the terms of the GNU Lesser General Public License as published by\r\n * the Free Software Foundation, either version 3 of the License, or\r\n * any later version.\r\n *\r\n * Xibo is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n * GNU Lesser General Public License for more details.\r\n *\r\n * You should have received a copy of the GNU Lesser General Public License\r\n * along with Xibo.  If not, see <http://www.gnu.org/licenses/>.\r\n */\r\nimport {\r\n    Layout, getLayout, getXlf, initRenderingDOM\r\n} from \"./Modules/Layout\";\r\nimport { platform } from './Modules/Platform';\r\nimport {\r\n    ILayout, initialLayout, InputLayoutType, OptionsType,\r\n} from \"./Types/Layout\";\r\nimport { ELayoutType, initialXlr, IXlr } from './Types/XLR';\r\n\r\nexport default function XiboLayoutRenderer(\r\n    inputLayouts: InputLayoutType[],\r\n    options?: OptionsType,\r\n) {\r\n    const props = {\r\n        inputLayouts,\r\n        options,\r\n    }\r\n\r\n    const xlrObject: IXlr = {\r\n        ...initialXlr,\r\n        bootstrap() {\r\n            // Place to set configurations and initialize required props\r\n            const self = this;\r\n            self.inputLayouts = !Array.isArray(props.inputLayouts) ?\r\n                [props.inputLayouts] : props.inputLayouts;\r\n            self.config = JSON.parse(JSON.stringify({...platform, ...props.options}));\r\n        },\r\n        init() {\r\n            return new Promise<IXlr>((resolve) => {\r\n                const self = this;\r\n\r\n                // Prepare rendering DOM\r\n                const previewCanvas = document.querySelector('.preview-canvas');\r\n\r\n                initRenderingDOM(previewCanvas);\r\n\r\n                self.prepareLayouts().then((xlr) => {\r\n                    resolve(xlr);\r\n                });\r\n            });\r\n        },\r\n\r\n        playSchedules(xlr: IXlr) {\r\n            // Check if there's a current layout\r\n            if (xlr.currentLayout !== undefined) {\r\n                xlr.currentLayout.emitter?.emit('start', xlr.currentLayout);\r\n                xlr.currentLayout.run();\r\n            }\r\n        },\r\n\r\n        async prepareLayoutXlf(inputLayout: ILayout) {\r\n            const self = this;\r\n            // Compose layout props first\r\n            let newOptions: OptionsType = Object.assign({}, platform);\r\n\r\n            newOptions = {\r\n                ...newOptions,\r\n                ...props.options,\r\n            };\r\n\r\n            if (self.config.platform ==='CMS' &&\r\n                inputLayout && Boolean(inputLayout.layoutId)\r\n            ) {\r\n                newOptions.xlfUrl =\r\n                    newOptions.xlfUrl.replace(':layoutId', String(inputLayout.layoutId));\r\n            } else if (self.config.platform === 'chromeOS') {\r\n                newOptions.xlfUrl = inputLayout.path as string;\r\n            }\r\n\r\n            let layoutXlf: string;\r\n            let layoutXlfNode: Document | null;\r\n            if (inputLayout && inputLayout.layoutNode === null) {\r\n                layoutXlf = await getXlf(newOptions);\r\n\r\n                const parser = new window.DOMParser();\r\n                layoutXlfNode = parser.parseFromString(layoutXlf as string, 'text/xml');\r\n            } else {\r\n                layoutXlfNode = inputLayout && inputLayout.layoutNode;\r\n            }\r\n\r\n            return new Promise<ILayout>((resolve) => {\r\n                const xlrLayoutObj = initialLayout;\r\n                \r\n                xlrLayoutObj.id = Number(inputLayout.layoutId);\r\n                xlrLayoutObj.layoutId = Number(inputLayout.layoutId);\r\n                xlrLayoutObj.options = newOptions;\r\n\r\n                resolve(Layout(layoutXlfNode, newOptions, self, xlrLayoutObj));\r\n            });\r\n        },\r\n\r\n        async prepareLayouts() {\r\n            const self = this;\r\n            // Get layouts\r\n            const xlrLayouts = getLayout({xlr: self});\r\n\r\n            self.currentLayoutId = xlrLayouts.current?.layoutId as ILayout['layoutId'];\r\n\r\n            const layoutsXlf = () => {\r\n                let xlf = [];\r\n\r\n                xlf.push(xlrLayouts.current);\r\n\r\n                if (xlrLayouts.current?.layoutId !== xlrLayouts.next?.layoutId) {\r\n                    xlf.push(xlrLayouts.next);\r\n                }\r\n\r\n                return xlf.reduce((coll: Promise<ILayout>[], item) => {\r\n                    return [\r\n                        ...coll,\r\n                        self.prepareLayoutXlf(item),\r\n                    ];\r\n                }, []);\r\n            };\r\n            const layouts = await Promise.all<Array<Promise<ILayout>>>(layoutsXlf());\r\n\r\n            return new Promise<IXlr>((resolve) => {\r\n                self.layouts = layouts;\r\n                self.currentLayout = self.layouts[0];\r\n\r\n                if (Boolean(self.layouts[1])) {\r\n                    self.nextLayout = self.layouts[1];\r\n                } else {\r\n                    // Use current layout as next layout if only one layout is available\r\n                    self.nextLayout = self.layouts[0];\r\n                }\r\n\r\n                self.currentLayoutIndex = xlrLayouts.currentLayoutIndex;\r\n                self.layouts[self.currentLayoutIndex] = self.currentLayout;\r\n\r\n                resolve(self);\r\n            });\r\n        },\r\n    }\r\n\r\n    xlrObject.bootstrap();\r\n\r\n    return xlrObject;\r\n}\r\n"],"names":["createNanoEvents","emit","event","args","i","callbacks","this","events","length","on","cb","push","filter","platform","getResourceUrl","xlfUrl","layoutBackgroundDownloadUrl","layoutPreviewUrl","libraryDownloadUrl","loaderUrl","idCounter","inPreview","appHost","initialLayout","id","layoutId","sw","sh","xw","xh","zIndex","scaleFactor","sWidth","sHeight","offsetX","offsetY","bgColor","bgImage","bgId","containerName","layoutNode","regionMaxZIndex","ready","regionObjects","drawer","allExpired","regions","actions","options","done","allEnded","path","prepareLayout","parseXlf","run","callback","regionExpired","end","regionEnded","stopAllMedia","Promise","resolve","nextId","getMediaId","mediaType","mediaId","capitalizeStr","inputStr","String","charAt","toUpperCase","substring","async","preloadMediaBlob","src","type","res","fetch","mode","blob","Blob","data","arrayBuffer","audioFileType","getFileExt","URL","createObjectURL","filename","filenameArr","split","str","validAudioTypes","mp3","wav","ogg","Boolean","initialRegion","layout","regionId","xml","mediaObjects","mediaObjectsActions","currentMedia","complete","ending","ended","oneMedia","oldMedia","undefined","curMedia","nxtMedia","currentMediaIndex","totalMediaObjects","index","prepareRegion","playNextMedia","transitionNodes","finished","exitTransition","exitTransitionComplete","prepareMediaObjects","initialMedia","region","html","iframe","iframeName","render","attachedAudio","singlePlay","timeoutId","setTimeout","checkIframeStatus","loadIframeOnRun","tempSrc","schemaVersion","duration","useDuration","fileId","uri","divWidth","divHeight","url","loop","init","stop","defaultTrans","trans","keyframes","display","timing","fadeOutElem","opacity","fill","flyInElem","keyframeOptions","direction","flyInKeyframes","flyInTiming","from","to","flyOutElem","flyOutKeyframes","flyOutTiming","transitionElement","transition","fadeIn","fadeOut","flyIn","flyOut","defaultIn","defaultOut","flyTransitionKeyframes","params","opacityAttr","source","top","height","left","width","VideoMedia","media","prepare","$videoMedia","preload","textContent","muted","mute","scaletype","style","objectFit","playsInline","document","getElementById","onloadstart","console","log","onloadeddata","readyState","oncanplay","videoPlayPromise","play","then","catch","error","onplaying","ondurationchange","onended","emitter","ObjectMedia","$objectMedia","setAttribute","$objMedia","Media","xlr","props","mediaTimer","mediaTimeCount","mediaObject","startMediaTimer","setInterval","$audioMedia","$playBtn","remove","audioPlayPromise","name","createElement","classList","add","addEventListener","parentNode","insertBefore","nextSibling","AudioMedia","clearInterval","self","getAttribute","parseInt","$mediaIframe","mediaOptions","getElementsByTagName","_options","Array","_mediaOptions","children","mediaOption","nodeName","toLowerCase","showfullscreen","scrolling","cssText","$mediaId","$media","Audio","className","resourceUrlParams","config","regionOptions","tmpUrl","resourceUrl","replace","cmsUrl","composeResourceUrlByPlatform","concat","align","valign","autoplay","regex","RegExp","json","err","fetchJSON","exec","transInDuration","Number","transinduration","fadeInTrans","animate","transInDirection","transindirection","defaultTransInOptions","transIn","transInName","getNewMedia","$region","lastElementChild","isCMS","setProperty","rej","reader","FileReader","onloadend","result","onerror","readAsDataURL","getDataBlob","innerHTML","appendChild","iframeStyles","showCurrentMedia","playAgainClickHandle","ev","preventDefault","history","go","getLayout","_currentLayout","_nextLayout","inputLayouts","currentLayout","nextLayout","currentLayoutIndex","currLayoutIndx","hasLayout","nextLayoutIndex","activeLayout","nextLayoutTemp","layoutsInput","layoutIndexes","reduce","a","b","indx","getIndexByLayoutId","layouts","current","next","Layout","$layout","prepareLayouts","parent","playSchedules","layoutObject","$layoutContainer","$splashScreen","$screen","outline","offsetWidth","offsetHeight","firstElementChild","Math","min","round","abs","position","indexOf","bgImageUrl","composeBgUrlByPlatform","backgroundImage","backgroundRepeat","backgroundSize","backgroundPosition","backgroundColor","currentLayoutId","layoutRegions","forEach","regionXml","regionObj","regionObject","_regionOptions","regionOption","regionMediaItems","mediaXml","mediaObj","nextMediaIndex","newMedia","transOutDuration","transOutDirection","transoutduration","transoutdirection","transOutName","defaultTransOutOptions","transOut","hideOldMedia","$oldMedia","removeOldMedia","oldMediaAnimate","effect","updateTiming","isDone","Region","layoutRegion","$end","$preview","firstChild","removeChild","j","ELayoutType","initialXlr","bootstrap","prepareLayoutXlf","inputLayout","xlrObject","isArray","JSON","parse","stringify","targetContainer","_targetContainer","previewPlayer","previewScreen","endPlay","playAgainLink","removeEventListener","body","querySelector","initRenderingDOM","layoutXlf","layoutXlfNode","newOptions","Object","assign","layoutOptions","apiHost","window","location","origin","text","getXlf","parser","DOMParser","parseFromString","xlrLayoutObj","xlrLayouts","all","xlf","coll","item","layoutsXlf"],"mappings":"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","x_google_ignoreList":[0]}